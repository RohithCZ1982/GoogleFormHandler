<!DOCTYPE html>
<html lang="kn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ಉಗ್ರರಥ</title>

<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex justify-center p-4">

<div class="bg-white w-full max-w-xl p-6 rounded-xl shadow-lg">

<h1 class="text-2xl font-bold text-center mb-4">ಉಗ್ರರಥ</h1>

<form id="form" class="space-y-3">

<input name="name" required placeholder="ಹೆಸರು *"
 class="w-full border p-2 rounded">

<input name="email" placeholder="ಇಮೇಲ್"
 class="w-full border p-2 rounded">

<input name="phone" placeholder="ಫೋನ್"
 class="w-full border p-2 rounded">

<textarea name="message" required placeholder="ಸಂದೇಶ *"
 class="w-full border p-2 rounded"></textarea>

<input type="file" id="file" accept="image/*,video/*"
 class="w-full border p-2 rounded">

<!-- Progress -->
<div id="progressBox" class="hidden mt-2">
  <div class="w-full bg-gray-200 h-3 rounded">
    <div id="bar" class="bg-emerald-500 h-3 rounded" style="width:0%"></div>
  </div>
  <p id="progressText" class="text-xs text-center mt-1">ಅಪ್ಲೋಡ್ 0%</p>
</div>

<button type="button" id="deleteBtn"
 class="hidden text-sm text-red-600 underline mt-2">
 ❌ ಅಪ್ಲೋಡ್ ಮಾಡಿದ ಫೈಲ್ ಅಳಿಸಿ
</button>

<button class="w-full bg-emerald-600 text-white py-2 rounded">
 ಫಾರ್ಮ್ ಸಲ್ಲಿಸಿ
</button>

<div id="msg" class="text-center mt-3"></div>

</form>
</div>

<script>
const BASE_URL = 'PASTE_YOUR_WEB_APP_URL_HERE';

const form = document.getElementById('form');
const fileInput = document.getElementById('file');
const msg = document.getElementById('msg');
const bar = document.getElementById('bar');
const progressBox = document.getElementById('progressBox');
const progressText = document.getElementById('progressText');
const deleteBtn = document.getElementById('deleteBtn');

let uploadedFile = null;

/******** IMAGE COMPRESSION ********/
async function compressImage(file) {
  return new Promise(res => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = () => img.src = reader.result;
    img.onload = () => {
      const c = document.createElement('canvas');
      const scale = Math.min(1, 1280 / img.width);
      c.width = img.width * scale;
      c.height = img.height * scale;
      c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
      c.toBlob(b => res(new File([b], file.name, { type: 'image/jpeg' })), 'image/jpeg', 0.7);
    };
    reader.readAsDataURL(file);
  });
}

/******** UPLOAD WITH PROGRESS ********/
function uploadFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    progressBox.classList.remove('hidden');

    reader.onload = () => {
      const data = new URLSearchParams();
      data.append('action', 'upload');
      data.append('file', reader.result.split(',')[1]);
      data.append('fileName', file.name);
      data.append('mimeType', file.type);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', BASE_URL);
      xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');

      xhr.upload.onprogress = e => {
        const p = Math.round((e.loaded / e.total) * 100);
        bar.style.width = p + '%';
        progressText.textContent = `ಅಪ್ಲೋಡ್ ${p}%`;
      };

      xhr.onload = () => {
        const r = JSON.parse(xhr.responseText);
        if (r.success) {
          uploadedFile = r;
          deleteBtn.classList.remove('hidden');
          resolve(r);
        } else reject();
      };

      xhr.onerror = reject;
      xhr.send(data.toString());
    };
    reader.readAsDataURL(file);
  });
}

/******** DELETE FILE ********/
deleteBtn.onclick = async () => {
  if (!uploadedFile) return;
  if (!confirm('ಈ ಫೈಲ್ ಅಳಿಸಲು ಖಚಿತವೇ?')) return;

  const p = new URLSearchParams();
  p.append('action','delete');
  p.append('fileId', uploadedFile.fileId);

  await fetch(BASE_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p});

  uploadedFile = null;
  fileInput.value = '';
  deleteBtn.classList.add('hidden');
  progressBox.classList.add('hidden');
  bar.style.width='0%';
  msg.textContent = 'ಫೈಲ್ ಅಳಿಸಲಾಗಿದೆ ✅';
};

/******** FORM SUBMIT ********/
form.onsubmit = async e => {
  e.preventDefault();
  msg.textContent = 'ಸಲ್ಲಿಸಲಾಗುತ್ತಿದೆ...';

  try {
    let file = fileInput.files[0];
    if (file?.type.startsWith('image/')) file = await compressImage(file);
    if (file) await uploadFile(file);

    await fetch(BASE_URL+'?action=submit',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name:form.name.value,
        email:form.email.value,
        phone:form.phone.value,
        message:form.message.value,
        fileName:uploadedFile?.fileName||'',
        fileUrl:uploadedFile?.fileUrl||''
      })
    });

    msg.textContent='ಯಶಸ್ವಿಯಾಗಿ ಸಲ್ಲಿಸಲಾಗಿದೆ ✅';
    form.reset();
    uploadedFile=null;
    deleteBtn.classList.add('hidden');
    progressBox.classList.add('hidden');
  } catch {
    msg.textContent='ದೋಷ ಸಂಭವಿಸಿದೆ ❌';
  }
};
</script>

</body>
</html>
